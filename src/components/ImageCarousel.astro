---
import fs from 'node:fs';
import path from 'node:path';

// Resolver ruta del directorio public/carousel en tiempo de build (compatible con Windows)
const carouselDir = path.resolve(process.cwd(), 'public', 'carousel');

let imageFiles: string[] = [];
try {
  const files = fs.readdirSync(carouselDir, { withFileTypes: true });
  imageFiles = files
    .filter((f) => f.isFile())
    .map((f) => f.name)
    .filter((name) => /\.(png|jpe?g|webp|gif|avif)$/i.test(name))
    .sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
} catch (err) {
  imageFiles = [];
}

const images = imageFiles.map((name) => ({
  src: `/carousel/${name}`,
  alt: name.replace(/[-_]/g, ' ').replace(/\.[^.]+$/, ''),
}));
---

{images.length === 0 ? (
  <div class="carousel-empty" role="status">No hay imágenes disponibles.</div>
) : (
  <div class="carousel" data-carousel>
    <div class="carousel-track">
      {images.map((img, i) => (
        <img
          src={img.src}
          alt={img.alt}
          class={i === 0 ? 'active' : ''}
          loading={i === 0 ? 'eager' : 'lazy'}
          decoding="async"
        />
      ))}
    </div>
    <button class="nav prev" data-prev aria-label="Anterior" title="Anterior">‹</button>
    <button class="nav next" data-next aria-label="Siguiente" title="Siguiente">›</button>
    <div class="indicators" role="tablist" aria-label="Paginación del carrusel">
      {images.map((_, i) => (
        <button
          class={i === 0 ? 'dot active' : 'dot'}
          data-dot
          aria-label={`Ir a la imagen ${i + 1}`}
          role="tab"
        />
      ))}
    </div>
    <script is:inline>
      (() => {
        const root = document.currentScript.closest('[data-carousel]');
        if (!root) return;
        const slides = Array.from(root.querySelectorAll('.carousel-track img'));
        if (slides.length === 0) return;
        const prev = root.querySelector('[data-prev]');
        const next = root.querySelector('[data-next]');
        const dots = Array.from(root.querySelectorAll('[data-dot]'));
        let index = 0;

        const show = (i) => {
          slides[index]?.classList.remove('active');
          dots[index]?.classList.remove('active');
          index = (i + slides.length) % slides.length;
          slides[index]?.classList.add('active');
          dots[index]?.classList.add('active');
        };

        prev?.addEventListener('click', () => { show(index - 1); restart(); });
        next?.addEventListener('click', () => { show(index + 1); restart(); });
        dots.forEach((btn, i) => btn.addEventListener('click', () => { show(i); restart(); }));

        let timer = null;
        const start = () => {
          if (slides.length <= 1) return;
          stop();
          timer = setInterval(() => show(index + 1), 5000);
        };
        const stop = () => { if (timer) clearInterval(timer); timer = null; };
        const restart = () => { stop(); start(); };

        root.addEventListener('mouseenter', stop);
        root.addEventListener('mouseleave', start);
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) stop(); else start();
        });

        start();
      })();
    </script>
  </div>
)}

<style>
  .carousel { position: relative; overflow: hidden; }
  .carousel-track { position: relative; height: 42vh; min-height: 220px; max-height: 520px; }
  .carousel-track img {
    position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
    opacity: 0; transition: opacity .6s ease; will-change: opacity; display: block;
    background: #111;
  }
  .carousel-track img.active { opacity: 1; }

  .nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: rgba(0,0,0,.45); color: #fff; border: 0; width: 40px; height: 40px;
    border-radius: 999px; display: grid; place-items: center; cursor: pointer;
    transition: background .2s ease; z-index: 2;
  }
  .nav:hover { background: rgba(0,0,0,.7); }
  .nav.prev { left: 10px; }
  .nav.next { right: 10px; }

  .indicators { position: absolute; left: 0; right: 0; bottom: 10px; display: flex; gap: 8px; justify-content: center; z-index: 2; }
  .dot { width: 8px; height: 8px; border-radius: 999px; border: 0; background: rgba(255,255,255,.5); cursor: pointer; padding: 0; }
  .dot.active { background: #fff; width: 22px; border-radius: 8px; }

  .carousel-empty { padding: 24px; text-align: center; color: #777; background: #f5f5f5; border-radius: 12px; }

  @media (prefers-reduced-motion: reduce) {
    .carousel-track img { transition: none; }
  }
</style>
